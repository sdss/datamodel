# Data Model: spFlat


migration: needs update


## Contents
- [Basic Information](#basic-information)
- [Changelog](#changelog)
- [Example HDUS List](#example-hdus-list)

---

## Basic Information
This file contains information about fiberflats, X-centers of fibers, fibermask, profile width and superflat obtained from extracted flat calibration frames. This file is generated
as a product of spcalib.pro.

### Naming Convention
Filenames have the form spFlat-[c][n]-mmmmmmmm.fits.gz, where c indicates either a blue or red spectrograph, n indicates the spectrograph number (1 or 2) and mmmmmmmm indicates the frame number. An example of filename is spFlat-r2-00111703.fits.gz.

### Releases
DR9, DR10, DR12, DR11, DR13, DR14, DR15, DR16, DR17, WORK

### Enviroments
BOSS_SPECTRO_REDUX

### Approximate Size
4 MB

### File Type
FITS

### Generated by Product
spCalib.pro

### HDUS List for release WORK
  - [HDU0: PRIMARY](#hdu0-primary)
  - [HDU1: ](#hdu1)
  - [HDU2: ](#hdu2)
  - [HDU3: ](#hdu3)
  - [HDU4: ](#hdu4)

---

## Changelog
Describes changes to the datamodel product and/or file structure from one release to another
 - WORK
   - from: DR17
   - primary_delta_nkeys: 21
   - added_primary_header_kwargs: ['HUMIDITY', 'DEWPOINT', 'DUSTB', 'DIDFLUSH', 'PRESSURE', 'SUBFRAME', 'AIRTEMP', 'PFERR', 'LN2TEMP', 'MGDPOS', 'DARKTIME', 'SLITID1', 'GUSTD', 'CCDTEMP', 'V_GUIDER', 'M1ZROT', 'V_BOSS', 'WINDD', 'TRUSTEMP', 'V_APO', 'SRVYMODE', 'GUSTS', 'DUSTA', 'M2ZROT', 'REQTIME', 'PLATETYP', 'MGDRA', 'V_SOP', 'WINDS25M', 'MGDDEC', 'WINDD25M', 'WINDS', 'IONPUMP']
   - removed_primary_header_kwargs: ['DAQVER', 'OBJOFFY', 'MC2TBCT', 'BOSSVER', 'MC2TEMDN', 'MC2THT', 'OBJOFFX', 'MC2HUMHT', 'MC2TRCT', 'MC2TBCB', 'MC2TRCB', 'MC2HUMCO']
 - DR17
   - from: DR16
   - note: No changes
 - DR16
   - from: DR15
   - note: No changes
 - DR15
   - from: DR14
   - note: No changes
 - DR14
   - from: DR13
   - note: No changes
 - DR13
   - from: DR11
   - note: No changes
 - DR11
   - from: DR12
   - note: No changes
 - DR12
   - from: DR10
   - note: No changes
 - DR10
   - from: DR9
   - note: No changes

---
## Example HDUS List

### HDU0: PRIMARY
PRIMARY HDU

#### HDU Type: IMAGE
#### HDU Size:  7 MB

##### Header Table Caption for HDU0
Key | Value | Comment | |
| --- | --- | --- | --- |
| SIMPLE | True | conforms to FITS standard |
| BITPIX | -32 | array data type |
| NAXIS | 2 | number of array dimensions |
| NAXIS1 | 4112 |  |
| NAXIS2 | 500 |  |
| EXTEND | True |  |
| TELESCOP | SDSS 2.5-M | Sloan Digital Sky Survey |
| FILENAME | sdR-b1-00318675.fit |  |
| CAMERAS | b1 |  |
| EXPOSURE | 318675 |  |
| V_BOSS | 5.0.1 | Active version of the BOSS ICC |
| CAMDAQ | 1.5.0:37 |  |
| SUBFRAME |  | the subframe readout command |
| ERRCNT | NONE |  |
| SYNCERR | NONE |  |
| SLINES | NONE |  |
| PIXERR | NONE |  |
| PLINES | NONE |  |
| PFERR | NONE |  |
| DIDFLUSH | True | CCD was flushed before integration |
| FLAVOR | flat | exposure type, SDSS spectro style |
| MJD | 59146 | APO fMJD day at start of exposure |
| TAI-BEG | 5110242160.0 | MJD(TAI) seconds at start of integration |
| DATE-OBS | 2020-10-24T07:42:40 | TAI date at start of integration |
| V_GUIDER | 3.8.1 | version of the current guiderActor |
| V_SOP | 4.0.1dev | version of the current sopActor |
| NAME | 15000-59144-02 | The name of the currently loaded plate |
| PLATEID | 15000 | The currently loaded plate |
| CARTID | 2 | The currently loaded cartridge |
| MAPID | 2 | The mapping version of the loaded plate |
| POINTING | A | The currently specified pointing |
| PLATETYP | BHM&MWM | Type of plate (e.g. BOSS, MANGA, APOGEE, APOGEE |
| SRVYMODE | BHM lead | Survey leading this observation and its mode |
| OBJSYS | ICRS | The TCC objSys |
| RA | 35.7083 | RA of telescope boresight (deg) |
| DEC | -5.05 | Dec of telescope boresight (deg) |
| RADEG | 35.7083 | RA of telescope pointing(deg) |
| DECDEG | -5.05 | Dec of telescope pointing (deg) |
| SPA | -9.50048419767952 | TCC SpiderInstAng |
| ROTPOS | 0.0 | Rotator request position (deg) |
| BOREOFFX | 0.0 | TCC Boresight offset, deg |
| BOREOFFY | 0.0 | TCC Boresight offset, deg |
| ARCOFFX | 0.0 | TCC ObjArcOff, deg |
| ARCOFFY | 0.0 | TCC ObjArcOff, deg |
| CALOFFX | 0.0 | TCC CalibOff, deg |
| CALOFFY | 0.0 | TCC CalibOff, deg |
| CALOFFR | 0.0 | TCC CalibOff, deg |
| GUIDOFFX | 0.0 | TCC GuideOff, deg |
| GUIDOFFY | 0.0 | TCC GuideOff, deg |
| GUIDOFFR | 0.0 | TCC GuideOff, deg |
| AZ | -11.190733 | Azimuth axis pos. (approx, deg) |
| ALT | 51.714232 | Altitude axis pos. (approx, deg) |
| IPA | 170.566208 | Rotator axis pos. (approx, deg) |
| FOCUS | 2819.8579 | User-specified focus offset (um) |
| M2PISTON | 1915.19 | TCC SecOrient |
| M2XTILT | -11.3 | TCC SecOrient |
| M2YTILT | -4.49 | TCC SecOrient |
| M2XTRAN | 16.99 | TCC SecOrient |
| M2YTRAN | -3.12 | TCC SecOrient |
| M2ZROT | -12.6 | TCC SecOrient |
| M1PISTON | -2029.13 | TCC PrimOrient |
| M1XTILT | 69.89 | TCC PrimOrient |
| M1YTILT | 100.0 | TCC PrimOrient |
| M1XTRAN | 372.35 | TCC PrimOrient |
| M1YTRAN | 622.11 | TCC PrimOrient |
| M1ZROT | -0.16 | TCC PrimOrient |
| SCALE | 1.000206 | User-specified scale factor |
| V_APO | v1_11 | version of the current apoActor |
| PRESSURE | 21.57 |  |
| WINDD | 248.5 |  |
| WINDS | 14.5 |  |
| GUSTD | 246.3 |  |
| GUSTS | 15.9 |  |
| AIRTEMP | NaN | failed to index KeyVar('apo', airTempPT=(None,) |
| DEWPOINT | NaN | failed to index KeyVar('apo', dpTempPT=(None,)) |
| TRUSTEMP | NaN | failed to index KeyVar('apo', truss25m=(None,)) |
| HUMIDITY | 54.3 |  |
| DUSTA | 39214.0 |  |
| DUSTB | 1836.0 |  |
| WINDD25M | NaN | failed to index KeyVar('apo', windd25m=(None,)) |
| WINDS25M | NaN | failed to index KeyVar('apo', winds25m=(None,)) |
| FF | 1 1 1 1 | FF lamps 1:on 0:0ff |
| NE | 0 0 0 0 | NE lamps 1:on 0:0ff |
| HGCD | 0 0 0 0 | HGCD lamps 1:on 0:0ff |
| FFS | 1 1 1 1 1 1 1 1 | Flatfield Screen 1:closed 0:open |
| MGDPOS | C | MaNGA dither position (C,N,S,E) |
| MGDRA | 0.0 | MaNGA decenter in RA, redundant with MGDPOS |
| MGDDEC | 0.0 | MaNGA decenter in Dec, redundant with MGDPOS |
| GUIDER1 | proc-gimg-0473.fits.gz | The first guider image |
| SLITID1 | 2 | Normalized slithead ID. sp1&2 should match. |
| GUIDERN | proc-gimg-0473.fits.gz | The last guider image |
| COLLA | 14207 | The position of the A collimator motor |
| COLLB | 15358 | The position of the B collimator motor |
| COLLC | 14781 | The position of the C collimator motor |
| HARTMANN | Out | Hartmanns: Left,Right,Out |
| MC1HUMHT | 10.4 | sp1 mech Hartmann humidity, % |
| MC1HUMCO | -5.1 | sp1 mech Central optics humidity, % |
| MC1TEMDN | 5.9 | sp1 mech Median temp, C |
| MC1THT | 5.7 | sp1 mech Hartmann Top Temp, C |
| MC1TRCB | 5.8 | sp1 mech Red Cam Bottom Temp, C |
| MC1TRCT | 6.4 | sp1 mech Red Cam Top Temp, C |
| MC1TBCB | 5.9 | sp1 mech Blue Cam Bottom Temp, C |
| MC1TBCT | 6.1 | sp1 mech Blue Cam Top Temp, C |
| REQTIME | 25.0 | requested exposure time |
| EXPTIME | 25.08 | measured exposure time, s |
| SHOPETIM | 0.75 | open shutter transit time, s |
| SHCLOTIM | 0.55 | close shutter transit time, s |
| DARKTIME | 36.79438614845276 | time between flush end and readout start |
| LN2TEMP | 95.312 |  |
| CCDTEMP | -99.609 |  |
| IONPUMP | -6.58 |  |
| CAMROW | 0 |  |
| CAMCOL | 1 |  |
| AUTHOR | Scott Burles & David Schlegel |  |
| VERSIDL | 8.7.2 | Version of IDL |
| VERSUTIL | v5_5_17 | Version of idlutils |
| VERSREAD | v6_0_4 | Version of idlspec2d for pre-processing raw dat |
| VERSLOG | trunk 27531 | Version of SPECLOG product |
| VERSFLAT | v1_32 | Version of SPECFLAT product |
| TWOPHASE | False |  |
| QUALITY | excellent |  |
| RDNOISE0 | 2.00796 | CCD read noise amp 0 [electrons] |
| RDNOISE1 | 1.97447 | CCD read noise amp 1 [electrons] |
| RDNOISE2 | 1.89665 | CCD read noise amp 2 [electrons] |
| RDNOISE3 | 1.85281 | CCD read noise amp 3 [electrons] |
| PIXFLAT | pixflatave-58751-b1.fits.gz |  |
| BADPIXEL | badpixels-58736-b1.fits.gz |  |
| NBRIGHT | 0 | Number of bright pixels (>10^5) in extracted fla |



### HDU1:
The HDU 1 data is a binary table whose fields are used to calculate the X-centers, for all fibers in the flat-field calibration frames. The Y-pixel positions on the CCD, which is the independent variable and the corresponding X-centers, which is the dependent variable are fitted to a functional form  and the resulting coefficients are stored in the binary table.

#### HDU Type: BINARY TABLE
#### HDU Size:  27 KB

##### Binary Table Caption for HDU1
Name | Type | Unit | Description |
| --- | --- | --- | --- |
 | FUNC | char[8] |  | function used to fit the Y-pixel positions on the CCD and corresponding X-centers are fitted to a functional form. |
 | XMIN | float64 |  | minimum value of the independent variable used by fitting function. |
 | XMAX | float64 |  | maximum value of the independent variable which is used along with the fitting coefficients, in the fitting function to get the value of dependent variable, which is the X-center of fibers. |
 | COEFF | float64[3500] |  | fit coefficents |



### HDU2:
The HDU 2 data stores the fibermask. These are fiber status bits and are set to non-zero to indicate bad status. The status bits used for masking are documented in $IDLUTILS/v5_4_12/data/sdss/sdssMaskbits.par.

#### HDU Type: IMAGE
#### HDU Size:  1 KB

##### Header Table Caption for HDU2
Key | Value | Comment | |
| --- | --- | --- | --- |
| XTENSION | IMAGE | Image Extension created by MWRFITS v1.11 |
| BITPIX | 32 |  |
| NAXIS | 1 |  |
| NAXIS1 | 500 |  |
| PCOUNT | 0 |  |
| GCOUNT | 1 |  |



### HDU3:
The data attribute of HDU 3 gives the first-order corrected profile width for each fiber bundle. This Gaussian sigma is in units of pixels. The X-positions on the CCD and their corresponding profile width are fitted to a functional form and the resulting coefficients are stored in a binary table. The X-position is the independent variable and the width is the dependent variable for the fitting function.

#### HDU Type: BINARY TABLE
#### HDU Size:  11 KB

##### Binary Table Caption for HDU3
Name | Type | Unit | Description |
| --- | --- | --- | --- |
 | FUNC | char[8] |  | function used to fit the Y-pixel positions on the CCD and corresponding X-centers are fitted to a functional form. |
 | XMIN | float64 |  | minimum value of the independent variable used by fitting function. |
 | XMAX | float64 |  | maximum value of the independent variable which is used along with the fitting coefficients, in the fitting function to get the value of dependent variable, which is the X-center of fibers. |
 | COEFF | float64[3500] |  | fit coefficents |



### HDU4:
The data attribute of HDU 4 contains superflat which is constructed from extracted flat-field image and is stored in a bspline set structure form. A superflat is a bspline average across all fibers of the flat spectrum in raw counts as a function of wavelength. The various column name are explained in the b-spline routine in $IDLUTILS/pro/bspline.

#### HDU Type: BINARY TABLE
#### HDU Size:  24 KB

##### Binary Table Caption for HDU4
Name | Type | Unit | Description |
| --- | --- | --- | --- |
 | FULLBKPT | float32[1806] |  | The fullbkpt vector |
 | BKMASK | int16[1806] |  | Bpline mask points. |
 | NORD | int32 |  | Polynomial norder of 2d fit |
 | COEFF | float32[1802] |  | Bspline fitting coefficients |
 | ICOEFF | float32[1802] |  | Bspline fitting coefficients |
